def group_field = 'data.code'
 |json_emitter()
 .every(700ms)
 .json(
     <<<{"code" : 224, "message": "this is a test", "mode": 1}>>>,
     <<<{"code" : 334, "message": "this is another test", "mode": 1}>>>,
     <<<{"code" : 114, "message": "this is another test", "mode": 2}>>>,
     <<<{"code" : 443, "message": "this is another test", "mode": 1}>>>,
     <<<{"code" : 224, "message": "this is another test", "mode": 2}>>>,
     <<<{"code" : 111, "message": "this is another test", "mode": 1}>>>,
     <<<{"code" : 551, "message": "this is another test", "mode": 2}>>>
 )
 .as('data')

%% |> group

|group_by(group_field)

|eval(
    lambda: string("data.code"),
    lambda: str_replace("data.message", 'test', string("data.code"))
    )
    .as(
    'data.group',
    'data.message')
|value_diff()
.fields('data.mode')
.as('data.mode_diff')
.mode('p-c')
|batch(3)
.timeout(12s)
|aggregate()
.fields('data.code')
.functions('sum')
.as('data.code_sum')
.keep('data')
|group_union()

%% |> end group

%|debug('alert')
%|log('text.txt')